---
title: "Panel data"
author: "Ryuya Ko"
date: "12/6/2019"
documentclass: ltjarticle
output: 
  pdf_document: 
    latex_engine: lualatex 
    keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# パネルデータ分析

- パネルデータ: クロスセクションデータを時系列に集計したもの。個別の観察単位に関して、複数期間に渡って観察・サンプリングしたもの

したがって、モデルは次のように表される:

$$
y_{it} = x_{it}^\prime\beta + \varepsilon_{it}\:\:\mathrm{for}\:\:i=1,\cdots, n, \:\: t=1,\cdots, T.
$$

そして、誤差項$\varepsilon_{it}$が次のように分解できると仮定する:

$$
\epsilon_{it} = \alpha_{i} + v_{it}.
$$

ここで、$\alpha_i$は時間を通じて一定の個別効果であり、$v_{it}$は真の意味での誤差項であり、$E[v_{it} | x_{i1},\cdots, x_{iT}] = 0$が成り立つ。

もし個別効果を$\alpha_i = z_{i}^\prime \gamma$などとして観察できるか、$\alpha_i = \alpha$とできるならば、これは通常のOLSとして扱うことができる(Pooled Regression)。

そうではない場合、通常では以下の2つのモデルが考えられる:

- 固定効果モデル(Fixed Effect Model):観測されない個別効果$\alpha_i$が存在し、$E[\alpha_i | x_{i1},\cdots, x_{iT}] \neq 0$である。

- ランダム効果モデル(Random Effect Model): 観測されない個別効果$u_i$が存在し、$\alpha_i | x_{i1},\cdots, x_{iT} \sim (0, \sigma_u^2)$である。

# 固定効果モデル

## Within Estimator
個別効果は時間を通じて一定であることから、各$i$について時間平均の偏差を求めることによって個別効果を除外できる:

$$
y_{it} - \bar{y}_i= (x_{it} - \bar{x}_i)^\prime \beta + v_{it} - \bar{v}_i
$$
$E[v_{it} | x_{i1},\cdots, x_{iT}] = 0$の仮定より、$y_{it} - \bar{y}_it$を$(x_{it} - \bar{x}_i)$に回帰することでBLUEな推定量を得られる。 これをFE estimatorと呼ぶ。

FE estimatorは次のように表され、Within estimatorとも呼ばれる:

$$
b_{FE} = [S^{within}_{xx}]^{-1}S_{xy}^{within}
$$
$$
S^{within}_{xx} = \sum_{i=1}^n \sum_{t=1}^T (x_{it} - \bar{x}_i)(x_{it} - \bar{x}_i)^\prime
$$

$$
S_{xy}^{within} = \sum_{i=1}^n \sum_{t=1}^T (x_{it} - \bar{x}_i)(y_{it} - \bar{y}_i)
$$

## ダミー変数による表現

固定効果をダミー変数を用いて表すことによって、FEモデルはLeast Squares Dummy Variable modelとも呼ばれる。(板書)

## Rによる実装
```{r setting}
setwd('~/econ/subsemi/introductory_econometrics/')
library(dplyr);library(wooldridge);
library(plm)
```


```{r data}
data("wagepan");help(wagepan)
head(wagepan[0:5])
```

データはF. Vella and M. Verbeek (1998), “Whose Wages Do Unions Raise? A Dynamic Model of Unionism and Wage Rate Determination for Young Men,” で用いられているものを使う。労働組合の活動による賃金上昇の男女差?を研究した論文らしい。

Rでのパネルデータ解析には`plm`パッケージを用いる。

まずは縦持ちになっているdata.frameをパネルデータに変換する
```{r panel}
p.df <- pdata.frame(wagepan, index=c("nr", "year"))
pdim(p.df) # dimensionを確認
```

Fixed Effect Modelの推定には、plm関数で`model="within"`を指定すればよい

```{r est_fe}
reg.fe <- plm(lwage~married+union+factor(year)*educ,
              data=p.df, model="within")
summary(reg.fe)
```